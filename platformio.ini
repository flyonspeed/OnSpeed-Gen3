; OnSpeed Gen3 ESP32 PlatformIO Configuration
;
; This configuration works alongside the existing Arduino IDE setup.
; Source files remain in software/OnSpeed-Gen3-ESP32/ and libraries
; remain in software/Libraries/ as git submodules.
;
; Install PlatformIO: https://platformio.org/
;
; Commands:
;   pio run              - Build firmware
;   pio run -t upload    - Build and upload to device
;   pio run -t clean     - Clean build artifacts
;   pio device monitor   - Serial monitor (921600 baud)

[platformio]
name = OnSpeed-Gen3
description = Open source AOA indicator with audio cues for general aviation
; Use the Arduino sketch folder as the source directory
src_dir = software/OnSpeed-Gen3-ESP32
; Only build ESP32 by default; native envs are for testing only (pio test -e native)
default_envs = esp32s3

[env:esp32s3]
; Use pioarduino platform for Arduino Core 3.x support (required for ESP_I2S, <bit>, etc.)
; Using version 55.03.35 which includes Arduino Core 3.3.5 (matches Arduino IDE)
; See: https://github.com/pioarduino/platform-espressif32
platform = https://github.com/pioarduino/platform-espressif32/releases/download/55.03.35/platform-espressif32.zip

; Target hardware: ESP32-S3-WROOM-2-N32R8V (32MB Flash Octal, 8MB PSRAM Octal)
; Board: "ESP32S3 Dev Module Octal (WROOM2)"
board = esp32-s3-devkitc-1-n32r8v
framework = arduino

; Generate buildinfo.cpp before build (updates version from git tags)
extra_scripts = pre:scripts/generate_buildinfo.py

; Flash settings to match Arduino IDE:
; - Flash Mode: "OPI 80MHz"
; - Flash Size: "32MB (256Mb)"
; - Partition Scheme: "32M Flash (4.8MB APP/22MB LittleFS)"
board_build.flash_mode = opi
board_build.f_flash = 80000000L
board_build.flash_size = 32MB
board_build.partitions = default_32MB.csv

; Upload settings
; - Upload Speed: "921600"
; - Upload Mode: "UART0 / Hardware CDC"
upload_speed = 921600
monitor_speed = 921600

; Build flags to match Arduino IDE settings:
; - USB CDC On Boot: "Disabled"
; - USB Mode: "Hardware CDC and JTAG"
; - PSRAM: "OPI PSRAM"
; - CPU Frequency: "240MHz (WiFi)"
; - Events Run On: "Core 0"
; - Arduino Runs On: "Core 1"
;
; Note: The board defines ARDUINO_EVENT_RUNNING_CORE=1 by default, but Arduino IDE
; uses Core 0 for events. We use build_unflags to remove the board default first.
build_unflags =
    -DARDUINO_EVENT_RUNNING_CORE=1
build_flags =
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=0
    -DBOARD_HAS_PSRAM
    -DARDUINO_RUNNING_CORE=1
    -DARDUINO_EVENT_RUNNING_CORE=0
    ; Stricter warnings for project code
    -Wall
    -Wextra

; Use the existing Libraries directory that contains git submodules
; This allows Arduino IDE and PlatformIO to share the same libraries
lib_extra_dirs =
    software/Libraries

; Explicitly include onspeed_core to ensure it's in the include path
lib_deps =
    onspeed_core

build_type = release

; =============================================================================
; Native test environment (runs on host machine, not ESP32)
; =============================================================================
[env:native]
platform = native
build_flags =
    -std=c++20
    -DUNIT_TEST
    -DNATIVE_BUILD
test_framework = unity
lib_extra_dirs =
    software/Libraries
lib_deps =
    throwtheswitch/Unity@^2.5.2
    onspeed_core

; =============================================================================
; Native test environment with code coverage (Linux CI only)
; =============================================================================
; This environment is designed for Linux CI with GCC. It will NOT work on macOS
; due to clang not supporting gcov-compatible coverage flags.
;
; CI Usage:
;   pio test -e native-coverage
;   lcov -c -d .pio/build/native-coverage -o coverage.info --rc lcov_branch_coverage=1
;   lcov --remove coverage.info '*/test/*' '*/Unity/*' -o coverage.info
;   genhtml coverage.info -o coverage-report
;
; For codecov.io, upload coverage.info after filtering.
;
[env:native-coverage]
platform = native
build_flags =
    -std=c++20
    -DUNIT_TEST
    -DNATIVE_BUILD
    ; Coverage flags for GCC (Linux CI)
    -fprofile-arcs
    -ftest-coverage
    -O0
    -g
; Disable optimization flags that interfere with coverage
build_unflags = -Os -O2 -O3
; Add --coverage to linker flags via script
extra_scripts = pre:scripts/coverage_link.py
test_framework = unity
lib_extra_dirs =
    software/Libraries
lib_deps =
    throwtheswitch/Unity@^2.5.2
    onspeed_core
